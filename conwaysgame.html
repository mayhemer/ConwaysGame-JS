<html>
  <!DOCTYPE html>
  <head>
    <script src="conwaysgame.js"></script>
    <script src="unittest.js" async="true"></script>
    <script>
      let active = false;
      const friendliness = [
        "white",
        "salmon",
        "green",
        "lightgreen",
        "lightblue",
        "lightgreen",
        "yellow",
        "white",
      ];

      function paint(context, x, y, c, n, f) {
        if (c == n) {
          return;
        }
        context.fillStyle = friendliness[f];
        if (n) {
          context.fillRect(x, y, 1, 1);
        } else {
          context.clearRect(x, y, 1, 1);
        }
      }

      function run(canvas, world) {
        const context = canvas.getContext("2d");
        return ConwayWorldGame.loop(
          world,
          (x, y, c, n, f) => {
            paint(context, x, y, c, n, f);
          },
          60
        );
      }

      function download(content, fileName, contentType) {
        var a = document.createElement("a");
        var file = new Blob([content], { type: contentType });
        a.href = URL.createObjectURL(file);
        a.download = fileName;
        a.click();
      }

      window.addEventListener("load", async () => {
        const starter = document.getElementById("run");
        const saver = document.getElementById("download");
        const loader = document.getElementById("upload");
        const canvas = document.getElementById("c");
        const context = canvas.getContext("2d");
        context.fillRect(0, 0, canvas.width, canvas.height);
        const rx = canvas.width / canvas.clientWidth;
        const ry = canvas.height / canvas.clientHeight;

        saver.addEventListener("click", () => {
          download(
            JSON.stringify(world),
            `conwaysworld-${new Date().getTime() / 1000}.json`,
            "application/json"
          );
        });

        loader.addEventListener("change", () => {
          const file = loader.files[0];
          const reader = new FileReader();
          reader.onload = (data) => {
            const w = JSON.parse(data.target.result);
            world = ConwayWorld.fromJSON(w);
            ConwayWorldGame.paint(null, world, (x, y, c, n, f) => {
              paint(context, x, y, c, n, f);
            });
          };
          reader.readAsText(file);
        });
        if (loader.files.length) {
          event = document.createEvent("HTMLEvents");
          event.initEvent("change", true, true);
          event.eventName = "change";
          loader.dispatchEvent(event);
        }

        starter.addEventListener("click", async () => {
          starter.setAttribute("disabled", true);
          loader.setAttribute("disabled", true);
          active = true;
          await run(canvas, world);
          console.log("All dead...");
          starter.setAttribute("disabled", false);
          active = false;
        });

        let world = new ConwayWorld(canvas.width, canvas.height);
        let drawing = false;
        let setting = false;

        const drawPixel = (x, y, d, s) => {
          if (d) {
            x = Math.trunc(x * rx);
            y = Math.trunc(y * ry);
            const c = world.getCell(x, y);
            if (c != s) {
              const f = world.neigbors(x, y);
              world.setCell(x, y, s);
              paint(context, x, y, c, s, f);
            }
          }
        };

        canvas.addEventListener("mousedown", (event) => {
          event.stopPropagation();
          drawing = !active;
          setting = !event.shiftKey;
          drawPixel(event.offsetX, event.offsetY, drawing, setting);
        });
        canvas.addEventListener("mouseup", () => {
          drawing = false;
        });
        canvas.addEventListener("mousemove", (event) => {
          drawPixel(event.offsetX, event.offsetY, drawing, setting);
        });
      });
    </script>
    <style>
      html {
        background: black;
        color: white;
      }
      button {
        margin: 1em auto;
      }
      canvas {
        width: 100%;
        height: 90wh;
        outline: solid 1px gray;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <button id="run">Start the game</button>
    <button id="download">Save the init world to a local file</button>
    Load a world from a local file:
    <input type="file" id="upload" accept="application/json" />
    <canvas id="c" width="300" height="150"></canvas>
  </body>
</html>
